https://github.com/ArtemLevin/Auth_sprint_2.git

# Запуск сервисов и генерация миграций

1. Очистка и остановка: Остановите и удалите все предыдущие контейнеры и тома для чистого старта:

**docker compose down -v**

2. Пересборка образа: Пересоберите образ auth-service после любых изменений в Dockerfile:

**docker compose build auth-service**

3. Запуск БД и Redis: Запустите только сервисы базы данных и Redis, дождитесь их готовности (healthy):

**docker compose up -d db redis**

**docker compose ps** # Проверить статус

4. Генерация миграции: Сгенерируйте начальную миграцию Alembic. Убедитесь, что файл миграции появился в auth_service/alembic/versions/ на вашей хост-машине:

**docker compose run --rm --entrypoint bash auth-service -c "alembic -c /app/alembic.ini revision --autogenerate -m \"Create initial tables\""**

5. Полный перезапуск сервисов: Остановите все сервисы и запустите их снова, чтобы применить сгенерированную миграцию:

**docker compose down**

**docker compose up -d**

**docker compose ps** # Убедитесь, что все сервисы Up (healthy)

# Партицирование по диапазону дат поля login_at

1. Сгенерировать заготовку миграции с нужными метаданными:

**docker compose run --rm --entrypoint bash auth-service \
  -c "alembic -c /app/alembic.ini revision --autogenerate -m \"Partition login_history by login_at\""**

2. Дополнить файл миграции DDL-командами из alembic/versions/create_login_history_partitions.py

3. Убедиться, что Docker-образ пересобран (если меняли Alembic-конфиг или зависимости):

**docker compose build auth-service**

4. Запустить базу данных и Redis

**docker compose up -d db redis**

**docker compose ps**

5. Применить миграции к БД, включая новую

**docker compose run --rm --entrypoint bash auth-service \
  -c "alembic -c /app/alembic.ini upgrade head"**

6. Перезапустить сервис авторизации

**docker compose up -d auth-service**

# Сервис Авторизации и Управления Ролями для Онлайн-Кинотеатра

## Описание Проекта

Этот проект представляет собой сервис авторизации и управления ролями, разработанный на FastAPI. Он является ключевым компонентом для онлайн-кинотеатра, обеспечивая безопасную аутентификацию пользователей и гибкую систему контроля доступа на основе ролей и разрешений. Сервис спроектирован с учетом масштабируемости и производительности, используя PostgreSQL для хранения данных и Redis для кэширования и управления токенами.

## Основные Возможности

Сервис реализует следующие API для взаимодействия с сайтом, личным кабинетом и системой управления доступами:

### API для Сайта и Личного Кабинета

*   **Регистрация пользователя**: Создание новой учетной записи.
*   **Вход пользователя в аккаунт**: Обмен логина и пароля на пару JWT-токенов (access и refresh).
*   **Обновление access-токена**: Получение нового access-токена с использованием refresh-токена.
*   **Выход пользователя из аккаунта**: Инвалидация токенов пользователя.
*   **Изменение логина или пароля**: Обновление личных данных пользователя.
*   **Получение истории входов**: Просмотр истории авторизаций пользователя.
*   **Многофакторная аутентификация (MFA)**: Функционал для настройки и верификации TOTP.
*   **"Выйти из остальных аккаунтов"**: Инвалидация всех активных сессий пользователя, кроме текущей.

### API для Управления Доступами

*   **CRUD для управления ролями**:
    *   Создание новой роли с определенными разрешениями.
    *   Удаление существующей роли.
    *   Изменение параметров роли (имя, описание, разрешения).
    *   Просмотр списка всех доступных ролей.
*   **Назначение пользователю роли**: Присвоение определенной роли пользователю.
*   **Отобрать у пользователя роль**: Удаление роли у пользователя.
*   **Метод для проверки наличия прав у пользователя**: Эндпоинт для проверки, обладает ли пользователь необходимым разрешением.

## Используемые Технологии

*   **Backend**: Python 3.12
*   **Web Framework**: FastAPI
*   **База данных**: PostgreSQL (через SQLAlchemy 2.0 с AsyncPG)
*   **Кэширование/Брокер сообщений**: Redis (через aioredis)
*   **Аутентификация**: JWT (JSON Web Tokens) с использованием `python-jose`
*   **Хеширование паролей**: `passlib` (bcrypt)
*   **Валидация данных**: Pydantic
*   **Управление зависимостями**: `pip`
*   **Контейнеризация**: Docker, Docker Compose
*   **Логирование**: `structlog`, `colorlog`
*   **Rate Limiting**: `slowapi`
*   **CLI утилиты**: `typer`
